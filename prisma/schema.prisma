generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  role              String             @default("teacher") // teacher | student
  plan              String?            @default("free") // free | pro
  name              String?
  email             String?            @unique
  hashedPassword    String?
  phone             String?            @unique
  avatar            String?
  currency          String             @default("â‚½")
  timezone          String             @default("Europe/Moscow")
  theme             String             @default("system")
  emailVerified     Boolean            @default(false)
  phoneVerified     Boolean            @default(false)
  twoFactorEnabled  Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  firstName         String?
  lastName          String?
  birthDate         DateTime?
  region            String?
  telegramId        String?            @unique
  telegramChatId    String?
  authProviders     AuthProvider[]
  groups            Group[]
  lessons           Lesson[]
  lessonSeries      LessonSeries[]
  students          Student[]
  subjects          Subject[]
  notifications     Notification[]
  notificationSettings NotificationSettings?
  verificationCodes VerificationCode[]
  learningPlans     LearningPlan[]
  onboardingCompleted Boolean            @default(false)
  referralCode      String?            @unique
  
  // PRO subscription fields
  isPro             Boolean            @default(false)
  proActivatedAt    DateTime?
  proExpiresAt      DateTime?
  lastPaymentId     String?
  
  studentRecords    Student[]          @relation("LinkedStudent")
  lessonRequests    LessonRequest[]    @relation("UserRequests")
}

model Subject {
  id           String         @id @default(cuid())
  name         String
  color        String         @default("#4A6CF7")
  icon         String?
  userId       String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  groups       Group[]
  lessons      Lesson[]
  lessonSeries LessonSeries[]
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  students     Student[]      @relation("StudentToSubject")
  learningPlans LearningPlan[]

  @@unique([userId, name])
}

model Student {
  id                String          @id @default(cuid())
  name              String
  slug              String?         @unique
  contact           String?
  contactType       String?         @default("phone")
  parentContact     String?
  parentContactType String?         @default("phone")
  note              String?
  ownerId           String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  lessons           Lesson[]
  lessonPayments    LessonPayment[]
  lessonSeries      LessonSeries[]
  owner             User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  groups            Group[]         @relation("GroupToStudent")
  subjects          Subject[]       @relation("StudentToSubject")
  learningPlans     LearningPlan[]

  linkedUserId      String?
  linkedUser        User?           @relation("LinkedStudent", fields: [linkedUserId], references: [id])
  invitationCode    String?         @unique

  @@index([ownerId])
  @@index([linkedUserId])
  @@index([ownerId, createdAt])
}

model Group {
  id           String         @id @default(cuid())
  name         String
  ownerId      String
  subjectId    String
  note         String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  owner        User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  subject      Subject        @relation(fields: [subjectId], references: [id])
  lessons      Lesson[]
  lessonSeries LessonSeries[]
  students     Student[]      @relation("GroupToStudent")
  learningPlan LearningPlan?

  @@index([ownerId])
  @@index([subjectId])
}

model LearningPlan {
  id        String   @id @default(cuid())
  studentId String?
  groupId   String?  @unique
  subjectId String?
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group     Group?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  subject   Subject? @relation(fields: [subjectId], references: [id])
  topics    LearningPlanTopic[]

  @@unique([studentId, subjectId])
  @@index([studentId])
  @@index([groupId])
  @@index([subjectId])
  @@index([ownerId])
}

model LearningPlanTopic {
  id          String   @id @default(cuid())
  planId      String
  title       String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  plan        LearningPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@index([planId])
}

model Lesson {
  id             String          @id @default(cuid())
  slug           String?         @unique
  date           DateTime
  price          Int
  isPaid         Boolean         @default(false)
  isCanceled     Boolean         @default(false)
  isTrial        Boolean         @default(false)
  status         String          @default("confirmed") // confirmed | pending_cancel | pending_reschedule
  notes          String?
  ownerId        String
  studentId      String?
  groupId        String?
  groupName      String?
  subjectId      String?
  subjectName    String?
  subjectColor   String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  topic          String?
  planTopicId    String?
  duration       Int             @default(60)
  seriesId       String?
  group          Group?          @relation(fields: [groupId], references: [id])
  owner          User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  series         LessonSeries?   @relation(fields: [seriesId], references: [id])
  student        Student?        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject        Subject?        @relation(fields: [subjectId], references: [id])
  planTopic      LearningPlanTopic? @relation(fields: [planTopicId], references: [id])
  lessonPayments LessonPayment[]
  lessonRequests LessonRequest[]

  @@index([ownerId])
  @@index([studentId])
  @@index([groupId])
  @@index([subjectId])
  @@index([seriesId])
  @@index([planTopicId])
  @@index([status])
  @@index([ownerId, date])
  @@index([ownerId, isPaid])
  @@index([ownerId, isCanceled])
}

model LessonRequest {
  id          String   @id @default(cuid())
  lessonId    String
  userId      String   // Student who made the request
  type        String   // reschedule | cancel
  newDate     DateTime?
  reason      String?
  status      String   @default("pending") // pending | approved | rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User     @relation("UserRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([userId])
  @@index([status])
}

model LessonSeries {
  id               String    @id @default(cuid())
  userId           String
  type             String
  interval         Int       @default(1)
  daysOfWeek       String
  startDate        DateTime
  endDate          DateTime?
  occurrencesCount Int?
  studentId        String?
  groupId          String?
  subjectId        String?
  price            Int
  topic            String?
  duration         Int       @default(60)
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lessons          Lesson[]
  group            Group?    @relation(fields: [groupId], references: [id])
  student          Student?  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject          Subject?  @relation(fields: [subjectId], references: [id])
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([studentId])
  @@index([groupId])
  @@index([subjectId])
}

model LessonPayment {
  id        String  @id @default(cuid())
  lessonId  String
  studentId String
  hasPaid   Boolean @default(false)
  lesson    Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([lessonId, studentId])
  @@index([lessonId])
  @@index([studentId])
}

model VerificationCode {
  id        String   @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  type      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}

model VerificationSession {
  id           String   @id @default(uuid())
  phone        String
  code         String
  expiresAt    DateTime
  attemptsLeft Int      @default(5)
  createdAt    DateTime @default(now())

  @@index([phone])
}

model EmailOTP {
  id           String   @id @default(uuid())
  email        String
  codeHash     String
  expiresAt    DateTime
  attemptsLeft Int      @default(5)
  createdAt    DateTime @default(now())

  @@index([email])
}

model AuthProvider {
  id         String   @id @default(cuid())
  userId     String
  provider   String
  providerId String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   // lesson_reminder, unpaid_lesson, lesson_created, lesson_rescheduled, lesson_deleted, income, debt, missing_lessons, onboarding, morning_briefing, evening_summary
  isRead    Boolean  @default(false)
  link      String?
  data      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  lessonReminders   Boolean  @default(true)
  unpaidLessons     Boolean  @default(true)
  statusChanges     Boolean  @default(true)
  incomeReports     Boolean  @default(true)
  studentDebts      Boolean  @default(true)
  missingLessons    Boolean  @default(true)
  onboardingTips    Boolean  @default(true)
  morningBriefing   Boolean  @default(true)
  eveningSummary    Boolean  @default(true)
  
  deliveryWeb       Boolean  @default(true)
  deliveryTelegram  Boolean  @default(false)
  
  quietHoursEnabled Boolean  @default(false)
  quietHoursStart   String?  @default("22:00")
  quietHoursEnd     String?  @default("08:00")
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
