generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                @id @default(cuid())
  name                    String?
  email                   String?               @unique
  hashedPassword          String?
  phone                   String?               @unique
  avatar                  String?
  currency                String                @default("â‚½")
  timezone                String                @default("Europe/Moscow")
  theme                   String                @default("system")
  emailVerified           Boolean               @default(false)
  phoneVerified           Boolean               @default(false)
  twoFactorEnabled        Boolean               @default(false)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  firstName               String?
  lastName                String?
  birthDate               DateTime?
  region                  String?
  telegramChatId          String?
  telegramId              String?               @unique
  onboardingCompleted     Boolean               @default(false)
  referralCode            String?               @unique
  role                    String                @default("teacher")
  plan                    String?               @default("free")
  isPro                   Boolean               @default(false)
  lastPaymentId           String?
  proActivatedAt          DateTime?
  proExpiresAt            DateTime?
  bonusMonthsEarned       Int                   @default(0)
  invitedById             String?
  referralBonusClaimed    Boolean               @default(false)
  showInsightsBlock       Boolean               @default(true)
  showProgressBlock       Boolean               @default(true)
  commissionRate          Float?
  isPartner               Boolean               @default(false)
  partnerBalance          Float                 @default(0)
  partnerCode             String?               @unique
  invitedByPartnerCode    String?
  commissionPaymentsLimit Int                   @default(3)
  invitedByPartnerAt      DateTime?
  partnerPaymentsCount    Int                   @default(0)
  country                 String?
  authProviders           AuthProvider[]
  groups                  Group[]
  learningPlans           LearningPlan[]
  lessons                 Lesson[]
  lessonRequests          LessonRequest[]       @relation("UserRequests")
  lessonSeries            LessonSeries[]
  notifications           Notification[]
  notificationSettings    NotificationSettings?
  partnerTransactions     PartnerTransaction[]  @relation("PartnerOwner")
  studentRecords          Student[]             @relation("LinkedStudent")
  students                Student[]
  subjects                Subject[]
  invitedBy               User?                 @relation("ReferralTree", fields: [invitedById], references: [id])
  invitedUsers            User[]                @relation("ReferralTree")
  verificationCodes       VerificationCode[]
}

model PartnerTransaction {
  id           String   @id @default(cuid())
  partnerId    String
  amount       Float
  type         String
  status       String   @default("completed")
  sourceUserId String?
  paymentId    String?
  description  String?
  createdAt    DateTime @default(now())
  partner      User     @relation("PartnerOwner", fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([createdAt])
}

model Subject {
  id            String         @id @default(cuid())
  name          String
  color         String         @default("#4A6CF7")
  icon          String?
  userId        String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  groups        Group[]
  learningPlans LearningPlan[]
  lessons       Lesson[]
  lessonSeries  LessonSeries[]
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  students      Student[]      @relation("StudentToSubject")

  @@unique([userId, name])
}

model Student {
  id                String          @id @default(cuid())
  name              String
  slug              String?         @unique
  contact           String?
  contactType       String?         @default("phone")
  parentContact     String?
  parentContactType String?         @default("phone")
  note              String?
  ownerId           String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  linkedUserId      String?
  invitationCode    String?         @unique
  defaultPrice      Int?
  learningPlans     LearningPlan[]
  lessons           Lesson[]
  lessonPayments    LessonPayment[]
  lessonSeries      LessonSeries[]
  linkedUser        User?           @relation("LinkedStudent", fields: [linkedUserId], references: [id])
  owner             User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  groups            Group[]         @relation("GroupToStudent")
  subjects          Subject[]       @relation("StudentToSubject")

  @@index([ownerId])
  @@index([linkedUserId])
  @@index([ownerId, createdAt])
}

model Group {
  id           String         @id @default(cuid())
  name         String
  ownerId      String
  subjectId    String
  note         String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  defaultPrice Int?
  owner        User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  subject      Subject        @relation(fields: [subjectId], references: [id])
  learningPlan LearningPlan?
  lessons      Lesson[]
  lessonSeries LessonSeries[]
  students     Student[]      @relation("GroupToStudent")

  @@index([ownerId])
  @@index([subjectId])
}

model LearningPlan {
  id        String              @id @default(cuid())
  studentId String?
  groupId   String?             @unique
  subjectId String?
  ownerId   String
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  group     Group?              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  owner     User                @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  student   Student?            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   Subject?            @relation(fields: [subjectId], references: [id])
  topics    LearningPlanTopic[]

  @@unique([studentId, subjectId])
  @@index([studentId])
  @@index([groupId])
  @@index([subjectId])
  @@index([ownerId])
}

model LearningPlanTopic {
  id          String       @id @default(cuid())
  title       String
  description String?
  order       Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  planId      String
  plan        LearningPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@index([planId])
}

model Lesson {
  id             String             @id @default(cuid())
  slug           String?            @unique
  date           DateTime
  price          Int
  isPaid         Boolean            @default(false)
  isCanceled     Boolean            @default(false)
  isTrial        Boolean            @default(false)
  notes          String?
  ownerId        String
  studentId      String?
  groupId        String?
  groupName      String?
  subjectId      String?
  subjectName    String?
  subjectColor   String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  topic          String?
  duration       Int                @default(60)
  seriesId       String?
  planTopicId    String?
  status         String             @default("confirmed")
  link           String?
  group          Group?             @relation(fields: [groupId], references: [id])
  owner          User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  planTopic      LearningPlanTopic? @relation(fields: [planTopicId], references: [id])
  series         LessonSeries?      @relation(fields: [seriesId], references: [id])
  student        Student?           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject        Subject?           @relation(fields: [subjectId], references: [id])
  lessonPayments LessonPayment[]
  lessonRequests LessonRequest[]

  @@index([ownerId])
  @@index([studentId])
  @@index([groupId])
  @@index([subjectId])
  @@index([seriesId])
  @@index([planTopicId])
  @@index([status])
  @@index([ownerId, date])
  @@index([ownerId, isPaid])
  @@index([ownerId, isCanceled])
}

model LessonRequest {
  id        String    @id @default(cuid())
  lessonId  String
  userId    String
  type      String
  newDate   DateTime?
  reason    String?
  status    String    @default("pending")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lesson    Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user      User      @relation("UserRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([userId])
  @@index([status])
}

model LessonSeries {
  id               String    @id @default(cuid())
  userId           String
  type             String
  interval         Int       @default(1)
  daysOfWeek       String
  startDate        DateTime
  endDate          DateTime?
  occurrencesCount Int?
  studentId        String?
  groupId          String?
  subjectId        String?
  price            Int
  topic            String?
  duration         Int       @default(60)
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  lessons          Lesson[]
  group            Group?    @relation(fields: [groupId], references: [id])
  student          Student?  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject          Subject?  @relation(fields: [subjectId], references: [id])
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([studentId])
  @@index([groupId])
  @@index([subjectId])
}

model LessonPayment {
  id        String  @id @default(cuid())
  lessonId  String
  studentId String
  hasPaid   Boolean @default(false)
  lesson    Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([lessonId, studentId])
  @@index([lessonId])
  @@index([studentId])
}

model VerificationCode {
  id        String   @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  type      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}

model VerificationSession {
  id           String   @id @default(uuid())
  phone        String
  code         String
  expiresAt    DateTime
  attemptsLeft Int      @default(5)
  createdAt    DateTime @default(now())

  @@index([phone])
}

model EmailOTP {
  id           String   @id @default(uuid())
  email        String
  codeHash     String
  expiresAt    DateTime
  attemptsLeft Int      @default(5)
  createdAt    DateTime @default(now())

  @@index([email])
}

model AuthProvider {
  id         String   @id @default(cuid())
  userId     String
  provider   String
  providerId String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  link      String?
  data      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationSettings {
  id                String  @id @default(cuid())
  userId            String  @unique
  lessonReminders   Boolean @default(true)
  unpaidLessons     Boolean @default(true)
  statusChanges     Boolean @default(true)
  incomeReports     Boolean @default(true)
  studentDebts      Boolean @default(true)
  missingLessons    Boolean @default(true)
  onboardingTips    Boolean @default(true)
  deliveryWeb       Boolean @default(true)
  deliveryTelegram  Boolean @default(false)
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String? @default("22:00")
  quietHoursEnd     String? @default("08:00")
  eveningSummary    Boolean @default(true)
  morningBriefing   Boolean @default(true)
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}
